{"version":3,"file":"auth.handler.js","names":["_bigquery","require","_bcryptjs","_interopRequireDefault","_auth","_nodeServerEngine","loginHandler","email","password","userQuery","query","authQueries","loginbyEmail","params","userRows","bigquery","length","Error","user","isMatch","bcrypt","compare","userDetailsQuery","getUserDetailsWithRole","userId","id","userDetailsRows","userDetails","transformedUser","firstName","lastName","jobBoardAccess","roleId","role","roleName","permissions","tokenExpiry","Math","floor","Date","now","accessToken","generateJwtToken","error","console","exports"],"sources":["../../../src/endpoints/auth/auth.handler.ts"],"sourcesContent":["import { bigquery } from '../../config/bigquery';\r\nimport bcrypt from 'bcryptjs';\r\nimport { authQueries } from '../../queries/auth/auth.queries';\r\nimport { generateJwtToken } from 'node-server-engine';\r\n\r\nexport const loginHandler = async (email: string, password: string) => {\r\n  try {\r\n    // Fetch user by email\r\n    const userQuery = {\r\n      query: authQueries.loginbyEmail,\r\n      params: { email }\r\n    };\r\n    const [userRows] = await bigquery.query(userQuery);\r\n\r\n    if (userRows.length === 0) {\r\n      throw new Error('User not found');\r\n    }\r\n\r\n    const user = userRows[0];\r\n\r\n    // Compare password\r\n    const isMatch = await bcrypt.compare(password, user.password);\r\n    if (!isMatch) {\r\n      throw new Error('Invalid credentials');\r\n    }\r\n\r\n    // Fetch user details, role, and permissions\r\n    const userDetailsQuery = {\r\n      query: authQueries.getUserDetailsWithRole,\r\n      params: { userId: user.id }\r\n    };\r\n\r\n    const [userDetailsRows] = await bigquery.query(userDetailsQuery);\r\n\r\n    if (userDetailsRows.length === 0) {\r\n      throw new Error('User role or permissions not found');\r\n    }\r\n\r\n    const userDetails = userDetailsRows[0];\r\n\r\n    // Transform user object\r\n    const transformedUser = {\r\n      id: userDetails.id,\r\n      firstName: userDetails.firstName,\r\n      lastName: userDetails.lastName,\r\n      email: userDetails.email,\r\n      jobBoardAccess: userDetails.jobBoardAccess,\r\n      roleId: userDetails.roleId,\r\n      role: userDetails.roleName,\r\n      permissions: userDetails.permissions || []\r\n    };\r\n\r\n    // Generate JWT Token\r\n    const tokenExpiry = Math.floor(Date.now() / 1000) + 1 * 60 * 60;  //1 hr\r\n\r\n    const accessToken = generateJwtToken(transformedUser);\r\n\r\n    return { accessToken, tokenExpiry, user: transformedUser };\r\n  } catch (error) {\r\n    console.error('Login error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n"],"mappings":";;;;;;;AAAA,IAAAA,SAAA,GAAAC,OAAA;AACA,IAAAC,SAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,KAAA,GAAAH,OAAA;AACA,IAAAI,iBAAA,GAAAJ,OAAA;AAEO,MAAMK,YAAY,GAAG,MAAAA,CAAOC,KAAa,EAAEC,QAAgB,KAAK;EACrE,IAAI;IACF;IACA,MAAMC,SAAS,GAAG;MAChBC,KAAK,EAAEC,iBAAW,CAACC,YAAY;MAC/BC,MAAM,EAAE;QAAEN;MAAM;IAClB,CAAC;IACD,MAAM,CAACO,QAAQ,CAAC,GAAG,MAAMC,kBAAQ,CAACL,KAAK,CAACD,SAAS,CAAC;IAElD,IAAIK,QAAQ,CAACE,MAAM,KAAK,CAAC,EAAE;MACzB,MAAM,IAAIC,KAAK,CAAC,gBAAgB,CAAC;IACnC;IAEA,MAAMC,IAAI,GAAGJ,QAAQ,CAAC,CAAC,CAAC;;IAExB;IACA,MAAMK,OAAO,GAAG,MAAMC,iBAAM,CAACC,OAAO,CAACb,QAAQ,EAAEU,IAAI,CAACV,QAAQ,CAAC;IAC7D,IAAI,CAACW,OAAO,EAAE;MACZ,MAAM,IAAIF,KAAK,CAAC,qBAAqB,CAAC;IACxC;;IAEA;IACA,MAAMK,gBAAgB,GAAG;MACvBZ,KAAK,EAAEC,iBAAW,CAACY,sBAAsB;MACzCV,MAAM,EAAE;QAAEW,MAAM,EAAEN,IAAI,CAACO;MAAG;IAC5B,CAAC;IAED,MAAM,CAACC,eAAe,CAAC,GAAG,MAAMX,kBAAQ,CAACL,KAAK,CAACY,gBAAgB,CAAC;IAEhE,IAAII,eAAe,CAACV,MAAM,KAAK,CAAC,EAAE;MAChC,MAAM,IAAIC,KAAK,CAAC,oCAAoC,CAAC;IACvD;IAEA,MAAMU,WAAW,GAAGD,eAAe,CAAC,CAAC,CAAC;;IAEtC;IACA,MAAME,eAAe,GAAG;MACtBH,EAAE,EAAEE,WAAW,CAACF,EAAE;MAClBI,SAAS,EAAEF,WAAW,CAACE,SAAS;MAChCC,QAAQ,EAAEH,WAAW,CAACG,QAAQ;MAC9BvB,KAAK,EAAEoB,WAAW,CAACpB,KAAK;MACxBwB,cAAc,EAAEJ,WAAW,CAACI,cAAc;MAC1CC,MAAM,EAAEL,WAAW,CAACK,MAAM;MAC1BC,IAAI,EAAEN,WAAW,CAACO,QAAQ;MAC1BC,WAAW,EAAER,WAAW,CAACQ,WAAW,IAAI;IAC1C,CAAC;;IAED;IACA,MAAMC,WAAW,GAAGC,IAAI,CAACC,KAAK,CAACC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,CAAE;;IAElE,MAAMC,WAAW,GAAG,IAAAC,kCAAgB,EAACd,eAAe,CAAC;IAErD,OAAO;MAAEa,WAAW;MAAEL,WAAW;MAAElB,IAAI,EAAEU;IAAgB,CAAC;EAC5D,CAAC,CAAC,OAAOe,KAAK,EAAE;IACdC,OAAO,CAACD,KAAK,CAAC,cAAc,EAAEA,KAAK,CAAC;IACpC,MAAMA,KAAK;EACb;AACF,CAAC;AAACE,OAAA,CAAAvC,YAAA,GAAAA,YAAA","ignoreList":[]}