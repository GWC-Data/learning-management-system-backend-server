{"version":3,"file":"assignmentCompletion.handler.js","names":["_uuid","require","_bigquery","_assignmentCompletion","_assignmentCompletionStorage","_audit","_class","TABLE_ASSIGNMENTCOMPLETION","process","env","TABLE_USER","checkAssignmentCompletionTableExists","console","log","rows","bigquery","query","PROJECT_ID","DATASET_ID","length","error","Error","createAssignmentCompletionTableIfNotExists","exists","createAssignmentCompletionHandler","req","assignmentCompletionData","file","user","classId","traineeId","obtainedMarks","obtainedPercentage","body","createAt","Date","toISOString","success","message","courseAssignmentResults","TABLE_CLASS","params","traineeResults","obtainedMarksNumber","Number","obtainedPercentageNumber","isNaN","checkQuery","existingAssignmentCompletion","warn","assignmentCompletionId","uuidv4","createdAt","uploadedFileUrl","fileName","originalname","split","pop","uploadAssignmentCompletionFileToGCS","buffer","mimetype","uploadError","id","courseAssignmentAnswerFile","createdBy","types","auditLogParams","entityType","entityId","action","previousData","newData","JSON","stringify","performedBy","auditQueries","insertAuditLog","errors","exports","getAllAssignmentCompletionsHandler","assignmentCompletionQueries","getAllAssignmentCompletions","getAssignmentCompletionByIdHandler","getAssignmentCompletionById","updateAssignmentCompletionHandler","updatedData","tableExists","assignmentCompletionResults","Array","isArray","assignmentCompletion","newFileUrl","classResult","classQueries","getClass","totalMarks","parseFloat","oldFileName","deleteAssignmentCompletionFileFromGCS","undefined","toString","queryParams","updatedBy","updatedAt","Object","entries","forEach","key","value","toFixed","updateFields","keys","filter","map","join","updateAssignmentCompletion","updatedAssignmentCompletion","deleteAssignmentCompletionHandler","deleteAssignmentCompletion"],"sources":["../../../src/endpoints/assignmentCompletion/assignmentCompletion.handler.ts"],"sourcesContent":["import { Request, Response } from 'express';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { bigquery } from '../../config/bigquery';\r\nimport { assignmentCompletionQueries } from '../../queries/assignmentCompletion/assignmentCompletion.queries';\r\nimport { AssignmentCompletion } from 'db';\r\nimport {\r\n  deleteAssignmentCompletionFileFromGCS,\r\n  uploadAssignmentCompletionFileToGCS\r\n} from '../../config/assignmentCompletionStorage';\r\nimport { auditQueries } from 'queries/audit/audit.queries';\r\nimport { classQueries } from 'queries/class/class.queries';\r\n\r\nconst TABLE_ASSIGNMENTCOMPLETION =\r\n  process.env.TABLE_ASSIGNMENTCOMPLETION || 'assignmentCompletions';\r\nconst TABLE_USER = process.env.TABLE_USER || 'users';\r\n\r\n// Function to check if the assignment completion table exists\r\nconst checkAssignmentCompletionTableExists = async (): Promise<boolean> => {\r\n  try {\r\n    console.log('Checking if assignment completion table exists...');\r\n    const [rows] = await bigquery.query({\r\n      query: `SELECT table_name FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.INFORMATION_SCHEMA.TABLES\\` WHERE table_name = '${TABLE_ASSIGNMENTCOMPLETION}'`\r\n    });\r\n    console.log(`Table exists: ${rows.length > 0}`);\r\n    return rows.length > 0;\r\n  } catch (error) {\r\n    console.error('Error checking table existence:', error);\r\n    throw new Error('Database error while checking table existence.');\r\n  }\r\n};\r\n\r\n// Function to create the assignment completion table if it does not exist\r\nconst createAssignmentCompletionTableIfNotExists = async (): Promise<void> => {\r\n  const exists = await checkAssignmentCompletionTableExists();\r\n  if (!exists) {\r\n    try {\r\n      console.log('Creating Assignment completion table...');\r\n      await bigquery.query({\r\n        query: `\r\n        CREATE TABLE \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${TABLE_ASSIGNMENTCOMPLETION}\\` (\r\n          id STRING NOT NULL,\r\n          classId STRING NOT NULL,\r\n          traineeId STRING NOT NULL,\r\n          obtainedMarks FLOAT64 NOT NULL,\r\n          obtainedPercentage FLOAT64 NOT NULL,\r\n          courseAssignmentAnswerFile STRING,\r\n          createdBy STRING NOT NULL,\r\n          updatedBy STRING,\r\n          createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n          updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n        )`\r\n      });\r\n      console.log('Assignment completion table created successfully.');\r\n    } catch (error) {\r\n      console.error('Error creating assignment completion table:', error);\r\n      throw new Error('Failed to create assignment completion table.');\r\n    }\r\n  }\r\n};\r\n\r\n// **Create AssignmentCompletion**\r\nexport const createAssignmentCompletionHandler = async (\r\n  req: Request,\r\n  assignmentCompletionData: AssignmentCompletion,\r\n  file?: Express.Multer.File\r\n) => {\r\n  try {\r\n\r\n    const { user } = req;\r\n    const { classId, traineeId, obtainedMarks, obtainedPercentage } = req.body;\r\n    const createAt = new Date().toISOString();\r\n\r\n    // Validate required fields\r\n    if (!classId || !traineeId) {\r\n      console.error(\"Missing required fields: classId or traineeId\");\r\n      return { success: false, message: \"classId and traineeId are required.\" };\r\n    }\r\n\r\n    const [courseAssignmentResults] = await bigquery.query({\r\n      query: `\r\n        SELECT id FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_CLASS}\\`\r\n        WHERE id = @classId;\r\n      `,\r\n      params: { classId }\r\n    });\r\n\r\n    if (courseAssignmentResults.length === 0) {\r\n      console.error(`Course assignment with ID ${classId} not found.`);\r\n      return { success: false, message: \"Invalid classId. No matching record found.\" };\r\n    }\r\n\r\n    // Check if traineeId exists in the `users` table\r\n    const [traineeResults] = await bigquery.query({\r\n      query: `\r\n        SELECT id FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_USER}\\`\r\n        WHERE id = @traineeId;\r\n      `,\r\n      params: { traineeId }\r\n    });\r\n\r\n    if (traineeResults.length === 0) {\r\n      console.error(`Trainee with ID ${traineeId} not found.`);\r\n      return { success: false, message: \"Invalid traineeId. No matching user found.\" };\r\n    }\r\n\r\n    // Convert values safely\r\n    const obtainedMarksNumber = Number(obtainedMarks);\r\n    const obtainedPercentageNumber = Number(obtainedPercentage);\r\n\r\n    if (isNaN(obtainedMarksNumber) || isNaN(obtainedPercentageNumber)) {\r\n      console.error(\"Invalid obtainedMarks or obtainedPercentage values:\", obtainedMarks, obtainedPercentage);\r\n      return { success: false, message: \"Invalid obtainedMarks or obtainedPercentage values.\" };\r\n    }\r\n\r\n    // Ensure table exists\r\n    await createAssignmentCompletionTableIfNotExists();\r\n\r\n    // Check if assignment completion already exists\r\n    const checkQuery = `\r\n      SELECT id FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${TABLE_ASSIGNMENTCOMPLETION}\\`\r\n      WHERE classId = @classId AND traineeId = @traineeId\r\n    `;\r\n\r\n    const [existingAssignmentCompletion] = await bigquery.query({\r\n      query: checkQuery,\r\n      params: { classId, traineeId }\r\n    });\r\n\r\n    if (existingAssignmentCompletion.length > 0) {\r\n      console.warn(\"Assignment completion already exists for classId:\", classId);\r\n      return { success: false, message: \"Assignment completion already exists.\" };\r\n    }\r\n\r\n    // Generate a new UUID\r\n    const assignmentCompletionId = uuidv4();\r\n    const createdAt = new Date().toISOString();\r\n    let uploadedFileUrl = \"\";\r\n\r\n    // Handle file upload if provided\r\n    if (file) {\r\n      try {\r\n        const fileName = `${assignmentCompletionId}.${file.originalname.split('.').pop()}`;\r\n        uploadedFileUrl = await uploadAssignmentCompletionFileToGCS(file.buffer, fileName, file.mimetype);\r\n        console.log(\"File uploaded successfully:\", uploadedFileUrl);\r\n      } catch (uploadError) {\r\n        console.error(\"File upload failed:\", uploadError);\r\n        return { success: false, message: \"Failed to upload file.\" };\r\n      }\r\n    }\r\n\r\n    // Insert into BigQuery\r\n    await bigquery.query({\r\n      query: `\r\n        INSERT INTO \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${TABLE_ASSIGNMENTCOMPLETION}\\`\r\n        (id, classId, traineeId, obtainedMarks, obtainedPercentage, courseAssignmentAnswerFile, createdBy, createdAt)\r\n        VALUES (@id, @classId, @traineeId, @obtainedMarks, @obtainedPercentage, @courseAssignmentAnswerFile, @createdBy, @createdAt)\r\n      `,\r\n      params: {\r\n        id: assignmentCompletionId,\r\n        classId,\r\n        traineeId,\r\n        obtainedMarks: obtainedMarksNumber,\r\n        obtainedPercentage: obtainedPercentageNumber,\r\n        courseAssignmentAnswerFile: uploadedFileUrl,\r\n        createdBy: user?.id || \"system\",\r\n        createdAt: createAt\r\n      },\r\n      types: {\r\n        obtainedMarks: \"FLOAT64\",\r\n        obtainedPercentage: \"FLOAT64\",\r\n        createdAt: \"TIMESTAMP\",\r\n        createdBy: \"STRING\",\r\n      },\r\n    });\r\n\r\n    // Insert Audit Log\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: \"AssignmentCompletion\",\r\n      entityId: assignmentCompletionId,\r\n      action: \"CREATE\",\r\n      previousData: null,\r\n      newData: JSON.stringify({\r\n        id: assignmentCompletionId,\r\n        classId,\r\n        traineeId,\r\n        obtainedMarks,\r\n        obtainedPercentage,\r\n        courseAssignmentAnswerFile: uploadedFileUrl,\r\n      }),\r\n      performedBy: user?.id || \"system\",\r\n      createdAt: createdAt,\r\n    };\r\n\r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { previousData: \"STRING\", newData: \"STRING\", createdAt: \"TIMESTAMP\" },\r\n    });\r\n\r\n    console.log(\"Assignment completion created successfully:\", assignmentCompletionId);\r\n    return { success: true, assignmentCompletionData };\r\n\r\n  } catch (error) {\r\n    console.error(\"Error processing request:\", error);\r\n    return {\r\n      success: false,\r\n      errors: [error instanceof Error ? error.message : \"Unknown error occurred.\"],\r\n    };\r\n  }\r\n};\r\n\r\n\r\n// **Get All Assignment Completions**\r\nexport const getAllAssignmentCompletionsHandler = async () => {\r\n  await checkAssignmentCompletionTableExists();\r\n  try {\r\n    console.log('Fetching all assignment completions...');\r\n    const [rows] = await bigquery.query({\r\n      query: assignmentCompletionQueries.getAllAssignmentCompletions\r\n    });\r\n    console.log(`Total assignment completions found: ${rows.length}`);\r\n    return rows;\r\n  } catch (error) {\r\n    console.error('Error fetching all assignment completions:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// **Get Assignment Completion By ID**\r\nexport const getAssignmentCompletionByIdHandler = async (id: string) => {\r\n  await checkAssignmentCompletionTableExists();\r\n  try {\r\n    console.log(`Fetching assignment completion with ID: ${id}`);\r\n    const [rows] = await bigquery.query({\r\n      query: assignmentCompletionQueries.getAssignmentCompletionById,\r\n      params: { id }\r\n    });\r\n    if (!rows.length) {\r\n      console.log(`No assignment completion found with ID: ${id}`);\r\n      return null;\r\n    }\r\n    console.log(`Assignment completion found:`, rows[0]);\r\n    return rows[0];\r\n  } catch (error) {\r\n    console.error(`Error fetching assignment completion with ID ${id}:`, error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// // **Update Assignment Completion**\r\n// export const updateAssignmentCompletionHandler = async (\r\n//   id: string,\r\n//   updatedData: AssignmentCompletion,\r\n//   file?: Express.Multer.File\r\n// ) => {\r\n//   try {\r\n//     console.log(`Updating assignment completion for ID: ${id}`);\r\n\r\n//     // Check if the table exists\r\n//     const tableExists = await checkAssignmentCompletionTableExists();\r\n//     if (!tableExists) {\r\n//       return {\r\n//         success: false,\r\n//         message: `Table '${TABLE_ASSIGNMENTCOMPLETION}' does not exist.`\r\n//       };\r\n//     }\r\n\r\n//     // Fetch existing assignment completion data\r\n//     const [assignmentCompletionResults] = await bigquery.query({\r\n//       query: `SELECT * FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${TABLE_ASSIGNMENTCOMPLETION}\\` WHERE id = @id`,\r\n//       params: { id }\r\n//     });\r\n\r\n//     if (\r\n//       !Array.isArray(assignmentCompletionResults) ||\r\n//       assignmentCompletionResults.length === 0\r\n//     ) {\r\n//       console.error(`Assignment completion with ID ${id} not found.`);\r\n//       return {\r\n//         success: false,\r\n//         errors: [`Assignment completion with ID ${id} not found.`]\r\n//       };\r\n//     }\r\n\r\n//     const assignmentCompletion = assignmentCompletionResults[0];\r\n//     let newFileUrl = assignmentCompletion.courseAssignmentAnswerFile;\r\n\r\n//     // Handle file update\r\n//     if (file) {\r\n//       try {\r\n//         // Delete old file if exists\r\n//         const oldFileName = assignmentCompletion.courseAssignmentAnswerFile\r\n//           ?.split('/')\r\n//           .pop();\r\n//         if (oldFileName) {\r\n//           await deleteAssignmentCompletionFileFromGCS(oldFileName);\r\n//         }\r\n\r\n//         // Upload new file\r\n//         const fileName = `${id}.${file.originalname.split('.').pop()}`;\r\n//         newFileUrl = await uploadAssignmentCompletionFileToGCS(\r\n//           file.buffer,\r\n//           fileName,\r\n//           file.mimetype\r\n//         );\r\n//       } catch (uploadError) {\r\n//         console.error('Error uploading file:', uploadError);\r\n//         return { success: false, message: 'Failed to upload file.' };\r\n//       }\r\n//     }\r\n\r\n//     // Prepare update values\r\n//     const queryParams: Record<string, any> = {\r\n//       id,\r\n//       updatedAt: new Date().toISOString()\r\n//     };\r\n//     if (newFileUrl !== assignmentCompletion.courseAssignmentAnswerFile) {\r\n//       queryParams.courseAssignmentAnswerFile = newFileUrl;\r\n//     }\r\n\r\n//     Object.entries(updatedData).forEach(([key, value]) => {\r\n//       if (value !== undefined) {\r\n//         queryParams[key] = value;\r\n//       }\r\n//     });\r\n\r\n//     // Construct dynamic update query\r\n//     const updateFields = Object.keys(queryParams)\r\n//       .filter((key) => key !== 'id')\r\n//       .map((key) => `${key} = @${key}`)\r\n//       .join(', ');\r\n\r\n//     if (!updateFields) {\r\n//       return { success: false, message: 'No fields provided for update.' };\r\n//     }\r\n\r\n//     // Execute update query\r\n//     await bigquery.query({\r\n//       query: `UPDATE \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${TABLE_ASSIGNMENTCOMPLETION}\\` SET ${updateFields} WHERE id = @id`,\r\n//       params: queryParams\r\n//     });\r\n\r\n//     console.log(`Assignment completion with ID ${id} updated successfully.`);\r\n//     return {\r\n//       success: true,\r\n//       message: `Assignment completion with ID ${id} updated successfully.`,\r\n//       courseAssignmentAnswerFile: newFileUrl\r\n//     };\r\n//   } catch (error) {\r\n//     console.error(`Error updating assignment completion with ID ${id}:`, error);\r\n//     return { success: false, errors: ['Internal server error occurred.'] };\r\n//   }\r\n// };\r\n\r\n// **Update Assignment Completion**\r\n\r\n// export const updateAssignmentCompletionHandler = async (\r\n//   req:any,\r\n//   id: string,\r\n//   updatedData: AssignmentCompletion,\r\n//   file?: Express.Multer.File\r\n// ) => {\r\n//   try {\r\n//     console.log(`Updating assignment completion for ID: ${id}`);\r\n\r\n//     const { user } = req;\r\n//     // Check if the table exists\r\n//     const tableExists = await checkAssignmentCompletionTableExists();\r\n//     console.log('Table', TABLE_ASSIGNMENTCOMPLETION);\r\n//     if (!tableExists) {\r\n//       return {\r\n//         success: false,\r\n//         message: `Table '${TABLE_ASSIGNMENTCOMPLETION}' does not exist.`\r\n//       };\r\n//     }\r\n\r\n//     // Fetch existing assignment completion data\r\n//     const [assignmentCompletionResults] = await bigquery.query({\r\n//       query: `SELECT * FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_ASSIGNMENTCOMPLETION}\\` WHERE id = @id`,\r\n//       params: { id }\r\n//     });\r\n\r\n//     console.log('assignmentCompletionResults', assignmentCompletionResults);\r\n\r\n//     if (\r\n//       !Array.isArray(assignmentCompletionResults) ||\r\n//       assignmentCompletionResults.length === 0\r\n//     ) {\r\n//       console.error(`Assignment completion with ID ${id} not found.`);\r\n//       return {\r\n//         success: false,\r\n//         errors: [`Assignment completion with ID ${id} not found.`]\r\n//       };\r\n//     }\r\n\r\n//     const assignmentCompletion = assignmentCompletionResults[0];\r\n//     let newFileUrl = assignmentCompletion.courseAssignmentAnswerFile;\r\n\r\n//     // Fetch totalMarks from class\r\n//     const [courseAssignmentResults] = await bigquery.query({\r\n//       query: classQueries.getAllClasses,\r\n//       params: { classId: assignmentCompletion.classId }\r\n//     });\r\n\r\n//     console.log(\r\n//       'assignmentCompletion.classId',\r\n//       assignmentCompletion.classId\r\n//     );\r\n\r\n//     console.log('courseAssignmentResults', courseAssignmentResults);\r\n\r\n//     if (\r\n//       !Array.isArray(courseAssignmentResults) ||\r\n//       courseAssignmentResults.length === 0\r\n//     ) {\r\n//       console.error(\r\n//         `Course assignment with ID ${assignmentCompletion.classId} not found.`\r\n//       );\r\n//       return {\r\n//         success: false,\r\n//         errors: [\r\n//           `Course assignment with ID ${assignmentCompletion.classId} not found.`\r\n//         ]\r\n//       };\r\n//     }\r\n\r\n//     const totalMarks = parseFloat(courseAssignmentResults[0].totalMarks);\r\n//     if (isNaN(totalMarks) || totalMarks <= 0) {\r\n//       console.error(\r\n//         `Invalid totalMarks value for course assignment: ${totalMarks}`\r\n//       );\r\n//       return {\r\n//         success: false,\r\n//         message: 'Invalid total marks for course assignment.'\r\n//       };\r\n//     }\r\n\r\n//     // Handle file update\r\n//     if (file) {\r\n//       try {\r\n//         // Delete old file if exists\r\n//         const oldFileName = assignmentCompletion.courseAssignmentAnswerFile\r\n//           ?.split('/')\r\n//           .pop();\r\n//         if (oldFileName) {\r\n//           await deleteAssignmentCompletionFileFromGCS(oldFileName);\r\n//         }\r\n\r\n//         // Upload new file\r\n//         const fileName = `${id}.${file.originalname.split('.').pop()}`;\r\n//         newFileUrl = await uploadAssignmentCompletionFileToGCS(\r\n//           file.buffer,\r\n//           fileName,\r\n//           file.mimetype\r\n//         );\r\n//       } catch (uploadError) {\r\n//         console.error('Error uploading file:', uploadError);\r\n//         return { success: false, message: 'Failed to upload file.' };\r\n//       }\r\n//     }\r\n\r\n//     // Calculate obtainedPercentage if obtainedMarks is provided\r\n//     let obtainedPercentage: number | undefined;\r\n//     if (updatedData.obtainedMarks !== undefined) {\r\n//       const obtainedMarksNumber = parseFloat(\r\n//         updatedData.obtainedMarks.toString()\r\n//       );\r\n//       console.log('obtainedMarksNumber', obtainedMarksNumber);\r\n//       console.log('totalMarks', totalMarks);\r\n//       if (isNaN(obtainedMarksNumber) || obtainedMarksNumber < 0) {\r\n//         return { success: false, message: 'Invalid obtained marks.' };\r\n//       }\r\n//       obtainedPercentage = (obtainedMarksNumber / totalMarks) * 100;\r\n//     }\r\n\r\n//     console.log('obtainedPercentage', obtainedPercentage);\r\n\r\n//     // Prepare update values\r\n//     const queryParams: Record<string, any> = {\r\n//       id,\r\n//       updatedBy: user?.id,\r\n//       updatedAt: new Date().toISOString(),\r\n//       courseAssignmentAnswerFile: newFileUrl || null \r\n//     };\r\n\r\n//     Object.entries(updatedData).forEach(([key, value]) => {\r\n//       if (value !== undefined) {\r\n//         queryParams[key] =\r\n//           key === 'obtainedMarks' ? parseFloat(value.toString()) : value;\r\n//       }\r\n//     });\r\n\r\n//     // Add obtainedPercentage to update query\r\n//     if (obtainedPercentage !== undefined) {\r\n//       queryParams.obtainedPercentage = parseFloat(\r\n//         obtainedPercentage.toFixed(2)\r\n//       );\r\n//     }\r\n\r\n//     // Construct dynamic update query\r\n//     const updateFields = Object.keys(queryParams)\r\n//       .filter((key) => key !== 'id')\r\n//       .map((key) => `${key} = @${key}`)\r\n//       .join(', ');\r\n\r\n//     if (!updateFields) {\r\n//       return { success: false, message: 'No fields provided for update.' };\r\n//     }\r\n\r\n//     console.log('QueryParams', queryParams);\r\n\r\n//     // Execute update query\r\n//     await bigquery.query({\r\n//       query: assignmentCompletionQueries.updateAssignmentCompletion,\r\n//       params: queryParams\r\n//     });\r\n\r\n//     console.log(`Assignment completion with ID ${id} updated successfully.`);\r\n\r\n//     // **Fetch the updated data**\r\n//     const [updatedAssignmentCompletion] = await bigquery.query({\r\n//       query: `SELECT * FROM teqcertify.lms.assignmentCompletions WHERE id = @id`,\r\n//       params: { id }\r\n//     });\r\n\r\n//     // ✅ Log audit trail\r\n//     const auditLogParams = {\r\n//       id: uuidv4(),\r\n//       entityType: \"AttendanceFile\",\r\n//       entityId: id,\r\n//       action: \"UPDATE\",\r\n//       previousData: JSON.stringify(assignmentCompletion), \r\n//       newData: JSON.stringify(updatedAssignmentCompletion[0]), \r\n//       performedBy: user?.id,\r\n//       createdAt: new Date().toISOString(),\r\n//     };\r\n\r\n//     await bigquery.query({\r\n//       query: auditQueries.insertAuditLog,\r\n//       params: auditLogParams,\r\n//       types: { previousData: \"STRING\", newData: \"STRING\" }, // Ensure JSON storage\r\n//     });\r\n\r\n//     return {\r\n//       success: true,\r\n//       message: `Assignment completion with ID ${id} updated successfully.`,\r\n//       updatedData: updatedAssignmentCompletion[0] // Returning the updated record\r\n//     };\r\n//   } catch (error) {\r\n//     console.error(`Error updating assignment completion with ID ${id}:`, error);\r\n//     return { success: false, errors: ['Internal server error occurred.'] };\r\n//   }\r\n// };\r\n\r\nexport const updateAssignmentCompletionHandler = async (\r\n  req: any,\r\n  id: string,\r\n  updatedData: AssignmentCompletion,\r\n  file?: Express.Multer.File\r\n) => {\r\n  try {\r\n    console.log(`Updating assignment completion for ID: ${id}`);\r\n\r\n    const { user } = req;\r\n    // Check if the table exists\r\n    const tableExists = await checkAssignmentCompletionTableExists();\r\n    console.log('Table', TABLE_ASSIGNMENTCOMPLETION);\r\n    if (!tableExists) {\r\n      return {\r\n        success: false,\r\n        message: `Table '${TABLE_ASSIGNMENTCOMPLETION}' does not exist.`\r\n      };\r\n    }\r\n\r\n    // Fetch existing assignment completion data\r\n    const [assignmentCompletionResults] = await bigquery.query({\r\n      query: `SELECT * FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_ASSIGNMENTCOMPLETION}\\` WHERE id = @id`,\r\n      params: { id }\r\n    });\r\n\r\n    console.log('assignmentCompletionResults', assignmentCompletionResults);\r\n\r\n    if (\r\n      !Array.isArray(assignmentCompletionResults) ||\r\n      assignmentCompletionResults.length === 0\r\n    ) {\r\n      console.error(`Assignment completion with ID ${id} not found.`);\r\n      return {\r\n        success: false,\r\n        errors: [`Assignment completion with ID ${id} not found.`]\r\n      };\r\n    }\r\n\r\n    const assignmentCompletion = assignmentCompletionResults[0];\r\n    let newFileUrl = assignmentCompletion.courseAssignmentAnswerFile;\r\n\r\n    // Fetch totalMarks from class\r\n    const [classResult] = await bigquery.query({\r\n      query: classQueries.getClass,\r\n      params: { classId: assignmentCompletion.classId }\r\n    });\r\n\r\n    console.log('assignmentCompletion.classId', assignmentCompletion.classId);\r\n    console.log('classResult', classResult);\r\n\r\n    if (\r\n      !Array.isArray(classResult) ||\r\n      classResult.length === 0\r\n    ) {\r\n      console.error(\r\n        `Class ID ${assignmentCompletion.classId} not found.`\r\n      );\r\n      return {\r\n        success: false,\r\n        errors: [\r\n          `class ID ${assignmentCompletion.classId} not found.`\r\n        ]\r\n      };\r\n    }\r\n\r\n    const totalMarks = parseFloat(classResult[0].totalMarks);\r\n    if (isNaN(totalMarks) || totalMarks <= 0) {\r\n      console.error(\r\n        `Invalid totalMarks value for course assignment: ${totalMarks}`\r\n      );\r\n      return {\r\n        success: false,\r\n        message: 'Invalid total marks for course assignment.'\r\n      };\r\n    }\r\n\r\n    // Handle file update\r\n    if (file) {\r\n      try {\r\n        // Delete old file if exists\r\n        const oldFileName = assignmentCompletion.courseAssignmentAnswerFile\r\n          ?.split('/')\r\n          .pop();\r\n        if (oldFileName) {\r\n          await deleteAssignmentCompletionFileFromGCS(oldFileName);\r\n        }\r\n\r\n        // Upload new file\r\n        const fileName = `${id}.${file.originalname.split('.').pop()}`;\r\n        newFileUrl = await uploadAssignmentCompletionFileToGCS(\r\n          file.buffer,\r\n          fileName,\r\n          file.mimetype\r\n        );\r\n      } catch (uploadError) {\r\n        console.error('Error uploading file:', uploadError);\r\n        return { success: false, message: 'Failed to upload file.' };\r\n      }\r\n    }\r\n\r\n    // Calculate obtainedPercentage if obtainedMarks is provided\r\n    let obtainedPercentage: number | undefined;\r\n    if (updatedData.obtainedMarks !== undefined) {\r\n      const obtainedMarksNumber = parseFloat(\r\n        updatedData.obtainedMarks.toString()\r\n      );\r\n      console.log('obtainedMarksNumber', obtainedMarksNumber);\r\n      console.log('totalMarks', totalMarks);\r\n      if (isNaN(obtainedMarksNumber) || obtainedMarksNumber < 0) {\r\n        return { success: false, message: 'Invalid obtained marks.' };\r\n      }\r\n      obtainedPercentage = (obtainedMarksNumber / totalMarks) * 100;\r\n    }\r\n\r\n    console.log('obtainedPercentage', obtainedPercentage);\r\n\r\n    // Prepare update values\r\n    const queryParams: Record<string, any> = {\r\n      id,\r\n      updatedBy: user?.id,\r\n      updatedAt: new Date().toISOString(),\r\n      courseAssignmentAnswerFile: newFileUrl || null\r\n    };\r\n\r\n    Object.entries(updatedData).forEach(([key, value]) => {\r\n      if (value !== undefined) {\r\n        queryParams[key] =\r\n          key === 'obtainedMarks' ? parseFloat(value.toString()) : value;\r\n      }\r\n    });\r\n\r\n    // Add obtainedPercentage to update query\r\n    if (obtainedPercentage !== undefined) {\r\n      queryParams.obtainedPercentage = parseFloat(\r\n        obtainedPercentage.toFixed(2)\r\n      );\r\n    }\r\n\r\n    // Construct dynamic update query\r\n    const updateFields = Object.keys(queryParams)\r\n      .filter((key) => key !== 'id')\r\n      .map((key) => `${key} = @${key}`)\r\n      .join(', ');\r\n\r\n    if (!updateFields) {\r\n      return { success: false, message: 'No fields provided for update.' };\r\n    }\r\n\r\n    console.log('QueryParams', queryParams);\r\n\r\n    // Execute update query\r\n    await bigquery.query({\r\n      query: assignmentCompletionQueries.updateAssignmentCompletion,\r\n      params: queryParams\r\n    });\r\n\r\n    console.log(`Assignment completion with ID ${id} updated successfully.`);\r\n\r\n    // **Fetch the updated data**\r\n    const [updatedAssignmentCompletion] = await bigquery.query({\r\n      query: `SELECT * FROM teqcertify.lms.assignmentCompletions WHERE id = @id`,\r\n      params: { id }\r\n    });\r\n\r\n    // ✅ Log audit trail\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: \"AssignmentCompletion\",\r\n      entityId: id,\r\n      action: \"UPDATE\",\r\n      previousData: JSON.stringify(assignmentCompletion),\r\n      newData: JSON.stringify(updatedAssignmentCompletion[0]),\r\n      performedBy: user?.id,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { previousData: \"STRING\", newData: \"STRING\" }, // Ensure JSON storage\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      message: `Assignment completion with ID ${id} updated successfully.`,\r\n      updatedData: updatedAssignmentCompletion[0] // Returning the updated record\r\n    };\r\n  } catch (error) {\r\n    console.error(`Error updating assignment completion with ID ${id}:`, error);\r\n    return { success: false, errors: ['Internal server error occurred.'] };\r\n  }\r\n};\r\n\r\n\r\n// **Delete Assignment Completion**\r\nexport const deleteAssignmentCompletionHandler = async (req: any, id: string) => {\r\n  const { user } = req;\r\n  try {\r\n    console.log(`Deleting assignment completion with ID: ${id}`);\r\n    if (!(await checkAssignmentCompletionTableExists()))\r\n      throw new Error(`Table '${TABLE_ASSIGNMENTCOMPLETION}' does not exist.`);\r\n\r\n    const [rows] = await bigquery.query({\r\n      query: assignmentCompletionQueries.getAssignmentCompletionById,\r\n      params: { id }\r\n    });\r\n\r\n    if (!rows.length) {\r\n      console.log('Assignment completion not found.');\r\n      return { success: false, message: 'Assignment completion not found.' };\r\n    }\r\n\r\n    const assignmentCompletion = rows[0];\r\n\r\n    const fileName = rows[0].courseAssignmentAnswerFile?.split('/').pop();\r\n    if (fileName) {\r\n      console.log('Deleting assignment completion file...');\r\n      await deleteAssignmentCompletionFileFromGCS(fileName);\r\n    }\r\n\r\n    await bigquery.query({\r\n      query: assignmentCompletionQueries.deleteAssignmentCompletion,\r\n      params: { id }\r\n    });\r\n    console.log(`Assignment completion with ID ${id} deleted successfully.`);\r\n\r\n    // Insert Audit Log\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: \"AssignmentCompletion\",\r\n      entityId: id,\r\n      action: \"DELETE\",\r\n      previousData: JSON.stringify(assignmentCompletion),\r\n      newData: null,\r\n      performedBy: user?.id,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { previousData: \"STRING\", newData: \"STRING\" },\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      message: `Assignment completion with ID ${id} deleted successfully.`\r\n    };\r\n  } catch (error) {\r\n    console.error(`Error deleting assignment completion with ID ${id}:`, error);\r\n    return { success: false, errors: ['Internal server error occurred.'] };\r\n  }\r\n};\r\n"],"mappings":"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CAA2CiD,EAAE,EAAE,CAAC;IAC5D,MAAM,CAAChD,IAAI,CAAC,GAAG,MAAMC,kBAAQ,CAACC,KAAK,CAAC;MAClCA,KAAK,EAAEgE,iDAA2B,CAACG,2BAA2B;MAC9D1C,MAAM,EAAE;QAAEqB;MAAG;IACf,CAAC,CAAC;IACF,IAAI,CAAChD,IAAI,CAACK,MAAM,EAAE;MAChBP,OAAO,CAACC,GAAG,CAAC,2CAA2CiD,EAAE,EAAE,CAAC;MAC5D,OAAO,IAAI;IACb;IACAlD,OAAO,CAACC,GAAG,CAAC,8BAA8B,EAAEC,IAAI,CAAC,CAAC,CAAC,CAAC;IACpD,OAAOA,IAAI,CAAC,CAAC,CAAC;EAChB,CAAC,CAAC,OAAOM,KAAK,EAAE;IACdR,OAAO,CAACQ,KAAK,CAAC,gDAAgD0C,EAAE,GAAG,EAAE1C,KAAK,CAAC;IAC3E,MAAMA,KAAK;EACb;AACF,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA0D,OAAA,CAAAI,kCAAA,GAAAA,kCAAA;AAEO,MAAME,iCAAiC,GAAG,MAAAA,CAC/C3D,GAAQ,EACRqC,EAAU,EACVuB,WAAiC,EACjC1D,IAA0B,KACvB;EACH,IAAI;IACFf,OAAO,CAACC,GAAG,CAAC,0CAA0CiD,EAAE,EAAE,CAAC;IAE3D,MAAM;MAAElC;IAAK,CAAC,GAAGH,GAAG;IACpB;IACA,MAAM6D,WAAW,GAAG,MAAM3E,oCAAoC,CAAC,CAAC;IAChEC,OAAO,CAACC,GAAG,CAAC,OAAO,EAAEN,0BAA0B,CAAC;IAChD,IAAI,CAAC+E,WAAW,EAAE;MAChB,OAAO;QACLjD,OAAO,EAAE,KAAK;QACdC,OAAO,EAAE,UAAU/B,0BAA0B;MAC/C,CAAC;IACH;;IAEA;IACA,MAAM,CAACgF,2BAA2B,CAAC,GAAG,MAAMxE,kBAAQ,CAACC,KAAK,CAAC;MACzDA,KAAK,EAAE,mBAAmBR,OAAO,CAA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","ignoreList":[]}