{"version":3,"file":"users.handler.js","names":["_bigquery","require","_user","_bcryptjs","_interopRequireDefault","_uuid","_userProfilePicStorage","_audit","TABLE_USER","process","env","checkUserTableExists","rows","bigquery","query","length","error","console","Error","createUserTableIfNotExists","log","createUserHandler","req","userData","JSON","stringify","body","user","firstName","lastName","email","phoneNumber","password","dateOfJoining","roleId","jobBoardAccess","success","errors","duplicateUsers","params","hashedPassword","bcrypt","hash","userId","uuidv4","createdAt","Date","toISOString","createdBy","id","userQueries","createUser","dateOfBirth","address","qualification","profilePic","accountStatus","types","updatedBy","auditLogParams","entityType","entityId","action","previousData","newData","performedBy","auditQueries","insertAuditLog","message","exports","getAllUsersHandler","getAllUsers","users","map","row","roleName","getUserByIdHandler","options","getUserById","updateUserForAdminHandler","updatedData","userQueryOptions","existingRows","existingUser","updateParams","split","updatedAt","updateQueryOptions","PROJECT_ID","DATASET_ID","updateResult","checkQueryOptions","checkRows","updateUserForTraineeHandler","file","newProfilePicUrl","oldFileName","pop","deleteUserProfilePicFromGCS","fileName","mimetype","uploadUserProfilePicToGCS","buffer","uploadError","updateTraineeUser","updateUserOptions","deleteUserHandler","userToDelete","profilePicUrl","deleteUser","imgError"],"sources":["../../../src/endpoints/users/users.handler.ts"],"sourcesContent":["import { bigquery } from '../../config/bigquery';\r\nimport { userQueries } from '../../queries/users/user.queries';\r\nimport bcrypt from 'bcryptjs';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { User } from 'db';\r\nimport {\r\n  deleteUserProfilePicFromGCS,\r\n  uploadUserProfilePicToGCS\r\n} from '../../config/userProfilePicStorage';\r\nimport { auditQueries } from 'queries/audit/audit.queries';\r\n\r\nconst TABLE_USER = process.env.TABLE_USER || 'users';\r\n\r\n// Function to check if the users table exists\r\nconst checkUserTableExists = async (): Promise<boolean> => {\r\n  try {\r\n    const [rows] = await bigquery.query({\r\n      query: `SELECT table_name FROM \\`teqcertify.lms.INFORMATION_SCHEMA.TABLES\\` WHERE table_name = '${TABLE_USER}'`\r\n    });\r\n\r\n    return rows.length > 0;\r\n  } catch (error) {\r\n    console.error('Error checking table existence:', error);\r\n    throw new Error('Database error while checking table existence.');\r\n  }\r\n};\r\n\r\n// Function to create the users table if it does not exist\r\nconst createUserTableIfNotExists = async (): Promise<void> => {\r\n  if (!(await checkUserTableExists())) {\r\n    try {\r\n      await bigquery.query({\r\n        query: `\r\n          CREATE TABLE \\`teqcertify.lms.users\\` (\r\n            id STRING NOT NULL,\r\n            firstName STRING,\r\n            lastName STRING,\r\n            email STRING NOT NULL,\r\n            dateOfBirth STRING,\r\n            phoneNumber STRING,\r\n            password STRING NOT NULL,\r\n            dateOfJoining DATE,\r\n            address STRING,\r\n            qualification STRING,\r\n            profilePic STRING,\r\n            roleId STRING,\r\n            accountStatus STRING,\r\n            jobBoardAccess STRING,\r\n            createdBy STRING NOT NULL,\r\n            updatedBy STRING,\r\n            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n          )\r\n        `\r\n      });\r\n      console.log('Users table created successfully.');\r\n    } catch (error) {\r\n      console.error('Error creating users table:', error);\r\n      throw new Error('Failed to create users table.');\r\n    }\r\n  }\r\n};\r\n\r\nexport const createUserHandler = async (\r\n  req: any,\r\n  userData: any\r\n) => {\r\n  try {\r\n    console.log(\"Incoming Request Body:\", JSON.stringify(req.body, null, 2));\r\n \r\n    // Ensure required tables exist before inserting data\r\n    await createUserTableIfNotExists();\r\n \r\n    const { user } = req;\r\n    const {\r\n      firstName,\r\n      lastName,\r\n      email,\r\n      phoneNumber,\r\n      password,\r\n      dateOfJoining,\r\n      roleId,\r\n      jobBoardAccess\r\n    } = userData;\r\n \r\n    if (!firstName || !lastName || !email || !password || !roleId || !jobBoardAccess) {\r\n      return {\r\n        success: false,\r\n        errors: [\"Missing required fields: firstName, lastName, email, password, roleId or jobBoardAccess.\"]\r\n      };\r\n    }\r\n \r\n    // **Check for duplicate email or phone**\r\n    const [duplicateUsers] = await bigquery.query({\r\n      query: `SELECT id FROM \\`teqcertify.lms.users\\` WHERE email = @email OR phoneNumber = @phoneNumber`,\r\n      params: { email, phoneNumber }\r\n    });\r\n \r\n    if (duplicateUsers.length > 0) {\r\n      return {\r\n        success: false,\r\n        errors: ['Email or phone number already exists.']\r\n      };\r\n    }\r\n \r\n    // **Hash the password**\r\n    const hashedPassword = await bcrypt.hash(password, 10);\r\n    const userId = uuidv4();\r\n    const createdAt = new Date().toISOString();\r\n    const createdBy = user?.id || null;\r\n \r\n    // **Insert user into `users` table with NULL for empty values**\r\n    await bigquery.query({\r\n      query: userQueries.createUser,\r\n      params: {\r\n        id: userId,\r\n        firstName,\r\n        lastName,\r\n        email,\r\n        dateOfBirth: null, // ðŸ”¹ Set to NULL\r\n        phoneNumber,\r\n        password: hashedPassword,\r\n        dateOfJoining: dateOfJoining || null,\r\n        address: null, // ðŸ”¹ NULL instead of empty string\r\n        qualification: null, // ðŸ”¹ NULL instead of empty string\r\n        profilePic: null, // ðŸ”¹ NULL instead of empty string\r\n        roleId,\r\n        accountStatus: \"active\", // ðŸ”¹ Default to \"active\"\r\n        jobBoardAccess,\r\n        createdBy,\r\n        createdAt\r\n      },\r\n      types: {\r\n        dateOfBirth: \"STRING\",\r\n        address: \"STRING\",\r\n        qualification: \"STRING\",\r\n        profilePic: \"STRING\",\r\n        updatedBy: \"STRING\"\r\n      }\r\n    });\r\n \r\n    console.log('User created successfully:', userId);\r\n \r\n    // ðŸ”¹ **Insert Audit Log**\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: \"User\",\r\n      entityId: userId,\r\n      action: \"CREATE\",\r\n      previousData: null,\r\n      newData: JSON.stringify({\r\n        firstName,\r\n        lastName,\r\n        email,\r\n        phoneNumber,\r\n        roleId,\r\n        accountStatus: \"active\",\r\n        jobBoardAccess,\r\n        createdAt\r\n      }),\r\n      performedBy: createdBy,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n \r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { previousData: \"STRING\", newData: \"STRING\" }\r\n    });\r\n \r\n    return {\r\n      message: 'User created successfully.',\r\n      userId,\r\n      userData\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating user:', error);\r\n    return { success: false, errors: ['Internal server error occurred.'] };\r\n  }\r\n};\r\n\r\n\r\nexport const getAllUsersHandler = async () => {\r\n  try {\r\n    if (!(await checkUserTableExists()))\r\n      throw new Error(\"Table 'users' does not exist.\");\r\n\r\n    const [rows] = await bigquery.query({ query: userQueries.getAllUsers });\r\n\r\n    // Map user data\r\n    const users = rows.map((row: any) => ({\r\n      id: row.userId,\r\n      firstName: row.firstName,\r\n      lastName: row.lastName,\r\n      email: row.email,\r\n      phoneNumber: row.phoneNumber,\r\n      dateOfBirth: row.dateOfBirth,\r\n      dateOfJoining: row.dateOfJoining,\r\n      address: row.address,\r\n      qualification: row.qualification,\r\n      profilePic: row.profilePic,\r\n      roleId: row.roleId,\r\n      roleName: row.roleName ?? \"No Role Assigned\", // âœ… Ensures roleName is included\r\n      accountStatus: row.accountStatus,\r\n      jobBoardAccess: row.jobBoardAccess\r\n}));\r\n\r\n    return users;\r\n  } catch (error) {\r\n    console.error(\"Error fetching all users:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n\r\nexport const getUserByIdHandler = async (id: string) => {\r\n  try {\r\n    if (!(await checkUserTableExists())) {\r\n      throw new Error(\"Table 'users' does not exist.\");\r\n    }\r\n\r\n    const options = {\r\n      query: userQueries.getUserById,\r\n      params: { id } // âœ… Fixed incorrect reference to userId\r\n    };\r\n\r\n    const [rows] = await bigquery.query(options);\r\n\r\n    if (!rows || rows.length === 0) {\r\n      throw new Error(`User with ID ${id} not found.`);\r\n    }\r\n\r\n    // âœ… Define the user structure\r\n    const userData = {\r\n      id: rows[0].userId,\r\n      firstName: rows[0].firstName,\r\n      lastName: rows[0].lastName,\r\n      email: rows[0].email,\r\n      phoneNumber: rows[0].phoneNumber,\r\n      dateOfBirth: rows[0].dateOfBirth,\r\n      dateOfJoining: rows[0].dateOfJoining,\r\n      address: rows[0].address,\r\n      qualification: rows[0].qualification,\r\n      profilePic: rows[0].profilePic,\r\n      roleId: rows[0].roleId,\r\n      roleName: rows[0].roleName,\r\n      accountStatus: rows[0].accountStatus,\r\n      jobBoardAccess: rows[0].jobBoardAccess\r\n    };\r\n\r\n    return userData;\r\n  } catch (error) {\r\n    console.error(`Error fetching user with ID ${id}:`, error);\r\n    throw new Error(`Failed to fetch user data: ${error}`);\r\n  }\r\n};\r\n\r\n\r\n// export const updateUserForAdminHandler = async (\r\n//   req: any,\r\n//   userId: string,\r\n//   updatedData: Partial<User>\r\n// ) => {\r\n//   const { user } = req;\r\n//   try {\r\n//     // Fetch existing user data\r\n//     const userQueryOptions = {\r\n//       query: userQueries.getUserById,\r\n//       params: { id: userId }\r\n//     };\r\n \r\n//     const [existingRows] = await bigquery.query(userQueryOptions);\r\n \r\n//     if (existingRows.length === 0) {\r\n//       throw new Error(`User with ID ${userId} not found.`);\r\n//     }\r\n \r\n//     const existingUser = existingRows[0];\r\n \r\n//     // Prepare update values\r\n//     const updateParams: Record<string, any> = {\r\n//       id: userId,\r\n//       firstName: updatedData.firstName || null,\r\n//       lastName: updatedData.lastName || null,\r\n//       email: updatedData.email || null,\r\n//       phoneNumber: updatedData.phoneNumber || null,\r\n//       dateOfBirth: updatedData.dateOfBirth || null,\r\n//       // password: updatedData.password || null,\r\n//       // dateOfJoining: updatedData.dateOfJoining || null,\r\n//       qualification: updatedData.qualification || null,\r\n//       address: updatedData.address || null,\r\n//       roleId: updatedData.roleId || null,\r\n//       accountStatus: updatedData.accountStatus || null,\r\n//       updatedBy: user?.id,\r\n//       updatedAt: new Date().toISOString()\r\n//     };\r\n \r\n//     console.log('Update User Params:', updateParams);\r\n \r\n//     // Update user details\r\n//     await bigquery.query({\r\n//       query: userQueries.updateUserForAdmin,\r\n//       params: updateParams\r\n//     });\r\n \r\n//     // Insert audit log\r\n//     const auditLogParams = {\r\n//       id: uuidv4(),\r\n//       entityType: 'User',\r\n//       entityId: userId,\r\n//       action: 'UPDATE',\r\n//       previousData: JSON.stringify(existingUser),\r\n//       newData: JSON.stringify(updateParams),\r\n//       performedBy: user?.id || null,\r\n//       createdAt: new Date().toISOString()\r\n//     };\r\n \r\n//     await bigquery.query({\r\n//       query: auditQueries.insertAuditLog,\r\n//       params: auditLogParams,\r\n//       types: { previousData: 'STRING', newData: 'STRING' }\r\n//     });\r\n \r\n//     console.log('Audit log inserted successfully.');\r\n//     console.log(`User ${userId} updated successfully.`);\r\n \r\n//     return {\r\n//       id: userId,\r\n//       ...updatedData\r\n//     };\r\n//   } catch (error) {\r\n//     console.error(`Error updating user ${userId}:`, error);\r\n//     throw error;\r\n//   }\r\n// };\r\n\r\n\r\n// UPDATE user for trainee\r\n\r\n// export const updateUserForAdminHandler = async (\r\n//   req: any,\r\n//   userId: string,\r\n//   updatedData: Partial<User>\r\n// ) => {\r\n//   const { user } = req;\r\n//   try {\r\n//     // Fetch existing user data\r\n//     const userQueryOptions = {\r\n//       query: userQueries.getUserById,\r\n//       params: { id: userId }\r\n//     };\r\n \r\n//     const [existingRows] = await bigquery.query(userQueryOptions);\r\n \r\n//     if (existingRows.length === 0) {\r\n//       throw new Error(`User with ID ${userId} not found.`);\r\n//     }\r\n \r\n//     const existingUser = existingRows[0];\r\n \r\n//     // Prepare update values with explicit types for null values\r\n//     const updateParams: Record<string, any> = {\r\n//       id: userId,\r\n//       firstName: updatedData.firstName || null,\r\n//       lastName: updatedData.lastName || null,\r\n//       email: updatedData.email || null,\r\n//       phoneNumber: updatedData.phoneNumber || null,\r\n//       dateOfBirth: updatedData.dateOfBirth || null,\r\n//       qualification: updatedData.qualification || null,\r\n//       address: updatedData.address || null,\r\n//       roleId: updatedData.roleId || null,\r\n//       accountStatus: updatedData.accountStatus || null,\r\n//       updatedBy: user?.id,\r\n//       updatedAt: new Date().toISOString()\r\n//     };\r\n \r\n//     // Enhanced logging for debugging\r\n//     console.log('Existing User:', existingUser);\r\n//     console.log('Update Params:', JSON.stringify(updateParams, null, 2));\r\n \r\n//     // Specify types for all parameters, especially null values\r\n//     const updateQueryOptions = {\r\n//       query: userQueries.updateUserForAdmin,\r\n//       params: updateParams,\r\n//       types: {\r\n//         id: 'STRING',\r\n//         firstName: 'STRING',\r\n//         lastName: 'STRING',\r\n//         email: 'STRING',\r\n//         phoneNumber: 'STRING',\r\n//         dateOfBirth: 'DATE',\r\n//         qualification: 'STRING',\r\n//         address: 'STRING',\r\n//         roleId: 'STRING',\r\n//         accountStatus: 'STRING',\r\n//         updatedBy: 'STRING',\r\n//         updatedAt: 'TIMESTAMP'\r\n//       }\r\n//     };\r\n \r\n//     // Validate parameters before query\r\n//     Object.entries(updateParams).forEach(([key, value]) => {\r\n//       if (value !== null && value !== undefined) {\r\n//         console.log(`Updating ${key}: ${value}`);\r\n//       }\r\n//     });\r\n \r\n//     // Perform the update query\r\n//     const [updateResult] = await bigquery.query(updateQueryOptions);\r\n//     console.log('Update Query Result:', updateResult);\r\n \r\n//     // Check affected rows\r\n//     const checkQueryOptions = {\r\n//       query: `\r\n//         SELECT * FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_USER}\\`\r\n//         WHERE id = @id\r\n//       `,\r\n//       params: { id: userId }\r\n//     };\r\n    \r\n//     const [checkRows] = await bigquery.query(checkQueryOptions);\r\n//     console.log('Updated User Check:', checkRows[0]);\r\n \r\n//     // Rest of the code remains the same...\r\n//     const auditLogParams = {\r\n//       id: uuidv4(),\r\n//       entityType: 'User',\r\n//       entityId: userId,\r\n//       action: 'UPDATE',\r\n//       previousData: JSON.stringify(existingUser),\r\n//       newData: JSON.stringify(updateParams),\r\n//       performedBy: user?.id || null,\r\n//       createdAt: new Date().toISOString()\r\n//     };\r\n \r\n//     await bigquery.query({\r\n//       query: auditQueries.insertAuditLog,\r\n//       params: auditLogParams,\r\n//       types: { \r\n//         id: 'STRING',\r\n//         entityType: 'STRING',\r\n//         entityId: 'STRING',\r\n//         action: 'STRING',\r\n//         previousData: 'STRING', \r\n//         newData: 'STRING',\r\n//         performedBy: 'STRING',\r\n//         createdAt: 'TIMESTAMP'\r\n//       }\r\n//     });\r\n \r\n//     console.log('Audit log inserted successfully.');\r\n//     console.log(`User ${userId} updated successfully.`);\r\n \r\n//     return {\r\n//       id: userId,\r\n//       ...updatedData\r\n//     };\r\n//   } catch (error) {\r\n//     console.error(`Error updating user ${userId}:`, error);\r\n//     throw error;\r\n//   }\r\n// };\r\n\r\nexport const updateUserForAdminHandler = async (\r\n  req: any,\r\n  userId: string,\r\n  updatedData: Partial<User>\r\n) => {\r\n  const { user } = req;\r\n  try {\r\n    // Fetch existing user data\r\n    const userQueryOptions = {\r\n      query: userQueries.getUserById,\r\n      params: { id: userId }\r\n    };\r\n \r\n    const [existingRows] = await bigquery.query(userQueryOptions);\r\n \r\n    if (existingRows.length === 0) {\r\n      throw new Error(`User with ID ${userId} not found.`);\r\n    }\r\n \r\n    const existingUser = existingRows[0];\r\n \r\n    // Prepare update values with explicit types for null values\r\n    const updateParams: Record<string, any> = {\r\n      id: userId,\r\n      firstName: updatedData.firstName || null,\r\n      lastName: updatedData.lastName || null,\r\n      email: updatedData.email || null,\r\n      phoneNumber: updatedData.phoneNumber || null,\r\n      dateOfBirth: updatedData.dateOfBirth \r\n        ? new Date(updatedData.dateOfBirth).toISOString().split('T')[0] \r\n        : null,\r\n      qualification: updatedData.qualification || null,\r\n      address: updatedData.address || null,\r\n      roleId: updatedData.roleId || null,\r\n      accountStatus: updatedData.accountStatus || null,\r\n      jobBoardAccess: updatedData.jobBoardAccess ? updatedData.jobBoardAccess : null,\r\n\r\n      updatedBy: user?.id,\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n \r\n    console.log('Update Params:', JSON.stringify(updateParams, null, 2));\r\n \r\n    // Specify types for all parameters, especially null values\r\n    const updateQueryOptions = {\r\n      query: `\r\n        UPDATE \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_USER}\\`\r\n        SET\r\n          firstName = COALESCE(@firstName, firstName),\r\n          lastName = COALESCE(@lastName, lastName),\r\n          email = COALESCE(@email, email),\r\n          phoneNumber = COALESCE(@phoneNumber, phoneNumber),\r\n          dateOfBirth = COALESCE(@dateOfBirth, dateOfBirth),\r\n          qualification = COALESCE(@qualification, qualification),\r\n          address = COALESCE(@address, address),\r\n          roleId = COALESCE(@roleId, roleId),\r\n          accountStatus = COALESCE(@accountStatus, accountStatus),\r\n          jobBoardAccess = IFNULL(@jobBoardAccess, jobBoardAccess),\r\n          updatedBy = @updatedBy,\r\n          updatedAt = @updatedAt\r\n        WHERE id = @id;\r\n        `,\r\n\r\n      params: updateParams,\r\n      types: {\r\n        id: 'STRING',\r\n        firstName: 'STRING',\r\n        lastName: 'STRING',\r\n        email: 'STRING',\r\n        phoneNumber: 'STRING',\r\n        dateOfBirth: 'STRING',\r\n        qualification: 'STRING',\r\n        address: 'STRING',\r\n        roleId: 'STRING',\r\n        accountStatus: 'STRING',\r\n        jobBoardAccess: 'STRING',\r\n        updatedBy: 'STRING',\r\n        updatedAt: 'TIMESTAMP'\r\n      }\r\n    };\r\n \r\n    // Perform the update query and get affected rows\r\n    const [updateResult] = await bigquery.query(updateQueryOptions);\r\n    console.log('Update Query Result:', updateResult);\r\n \r\n    // Verify the update by fetching the updated user\r\n    const checkQueryOptions = {\r\n      query: `\r\n        SELECT * FROM \\`${process.env.PROJECT_ID}.${process.env.DATASET_ID}.${process.env.TABLE_USER}\\`\r\n        WHERE id = @id\r\n      `,\r\n      params: { id: userId }\r\n    };\r\n    \r\n    const [checkRows] = await bigquery.query(checkQueryOptions);\r\n    console.log('Updated User Check:', checkRows[0]);\r\n \r\n    // Rest of the audit log insertion remains the same\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: 'User',\r\n      entityId: userId,\r\n      action: 'UPDATE',\r\n      previousData: JSON.stringify(existingUser),\r\n      newData: JSON.stringify(updateParams),\r\n      performedBy: user?.id || null,\r\n      createdAt: new Date().toISOString()\r\n    };\r\n \r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { \r\n        id: 'STRING',\r\n        entityType: 'STRING',\r\n        entityId: 'STRING',\r\n        action: 'STRING',\r\n        previousData: 'STRING', \r\n        newData: 'STRING',\r\n        performedBy: 'STRING',\r\n        createdAt: 'TIMESTAMP'\r\n      }\r\n    });\r\n \r\n    console.log('Audit log inserted successfully.');\r\n    console.log(`User ${userId} updated successfully.`);\r\n \r\n    return {\r\n      id: userId,\r\n      ...updatedData\r\n    };\r\n  } catch (error) {\r\n    console.error(`Error updating user ${userId}:`, error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport const updateUserForTraineeHandler = async (\r\n  req: any,\r\n  userId: string,\r\n  updatedData: Partial<User>,\r\n  file?: Express.Multer.File\r\n) => {\r\n  const { user } = req;\r\n  try {\r\n    // Fetch existing user data\r\n    const userQueryOptions = {\r\n      query: userQueries.getUserById,\r\n      params: { id: userId }\r\n    };\r\n \r\n    const [existingRows] = await bigquery.query(userQueryOptions);\r\n \r\n    if (existingRows.length === 0) {\r\n      throw new Error(`User with ID ${userId} not found.`);\r\n    }\r\n \r\n    const existingUser = existingRows[0];\r\n    let newProfilePicUrl = existingUser.profilePic;\r\n \r\n    // Handle Profile Picture Update\r\n    if (file) {\r\n      try {\r\n        const oldFileName = existingUser.profilePic?.split('/').pop();\r\n        if (oldFileName) {\r\n          await deleteUserProfilePicFromGCS(oldFileName);\r\n        }\r\n \r\n        const fileName = `${userId}.${file.mimetype.split('/')[1]}`;\r\n        newProfilePicUrl = await uploadUserProfilePicToGCS(\r\n          file.buffer,\r\n          fileName,\r\n          file.mimetype\r\n        );\r\n      } catch (uploadError) {\r\n        console.error('Error uploading profile picture:', uploadError);\r\n        throw new Error('Failed to upload profile picture.');\r\n      }\r\n    }\r\n \r\n    // Prepare update values\r\n    const updateParams: Record<string, any> = {\r\n      id: userId,\r\n      firstName: updatedData.firstName || existingUser.firstName,\r\n      lastName: updatedData.lastName || existingUser.lastName,\r\n      dateOfBirth: updatedData.dateOfBirth || existingUser.dateOfBirth,\r\n      phoneNumber: updatedData.phoneNumber || existingUser.phoneNumber,\r\n      address: updatedData.address || existingUser.address,\r\n      qualification: updatedData.qualification || existingUser.qualification,\r\n      profilePic: newProfilePicUrl || existingUser.profilePic,\r\n      updatedBy: user?.id,\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n \r\n    console.log('Update User Query:', userQueries.updateTraineeUser);\r\n    console.log('Update User Params:', updateParams);\r\n \r\n    // Update user details\r\n    const updateUserOptions = {\r\n      query: userQueries.updateTraineeUser, // Use new query reference\r\n      params: updateParams\r\n    };\r\n \r\n    await bigquery.query(updateUserOptions);\r\n \r\n    // Insert audit log\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: 'User',\r\n      entityId: userId,\r\n      action: 'UPDATE',\r\n      previousData: JSON.stringify(existingUser),\r\n      newData: JSON.stringify(updateParams),\r\n      performedBy: user?.id || null,\r\n      createdAt: new Date().toISOString()\r\n    };\r\n \r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { previousData: 'STRING', newData: 'STRING' }\r\n    });\r\n \r\n    console.log('Audit log inserted successfully.');\r\n    console.log(`User ${userId} updated successfully.`);\r\n \r\n    return {\r\n      id: userId,\r\n      ...updatedData,\r\n      profilePic: newProfilePicUrl || existingUser.profilePic\r\n    };\r\n  } catch (error) {\r\n    console.error(`Error updating user ${userId}:`, error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport const deleteUserHandler = async (req: any, id: string) => {\r\n  const { user } = req;\r\n  try {\r\n    // Check if 'users' table exists\r\n    if (!(await checkUserTableExists())) {\r\n      throw new Error(\"Table 'users' does not exist.\");\r\n    }\r\n\r\n    // Fetch user details to check existence and get profilePic URL\r\n    const [rows] = await bigquery.query({\r\n      query: userQueries.getUserById,\r\n      params: { id },\r\n    });\r\n\r\n    if (!rows.length) {\r\n      return { success: false, message: 'User not found.' };\r\n    }\r\n\r\n    const userToDelete = rows[0];\r\n    const profilePicUrl = userToDelete.profilePic;\r\n\r\n    // Extract the filename from the profilePic URL if available\r\n    let fileName: string | null = null;\r\n\r\n    if (profilePicUrl) {\r\n      fileName = profilePicUrl.split('/').pop();\r\n      console.log('Filename:', fileName);\r\n    } else {\r\n      console.log('Profile picture is not set for this user.');\r\n    }\r\n\r\n    console.log('Filename:', fileName);\r\n\r\n    console.log(`User's saved jobs deleted successfully.`);\r\n\r\n    // **Insert Audit Log Before Deletion**\r\n    const auditLogParams = {\r\n      id: uuidv4(),\r\n      entityType: \"User\", // Correct entity type\r\n      entityId: id,\r\n      action: \"DELETE\",\r\n      previousData: JSON.stringify(userToDelete), // Store full user data before deletion\r\n      newData: null, // No new data after deletion\r\n      performedBy: user?.id || null, // Who performed this action\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    await bigquery.query({\r\n      query: auditQueries.insertAuditLog,\r\n      params: auditLogParams,\r\n      types: { \r\n        previousData: \"STRING\", \r\n        newData: \"STRING\",  // Explicitly define null type\r\n        performedBy: \"STRING\" // Ensure performedBy is treated as a string\r\n      }\r\n    });    \r\n\r\n    console.log(`Audit log recorded for user deletion.`);\r\n\r\n    // **Delete user from database**\r\n    await bigquery.query({\r\n      query: userQueries.deleteUser,\r\n      params: { id },\r\n    });\r\n\r\n    console.log(`User record deleted.`);\r\n\r\n    // **Delete image from GCS if exists**\r\n    if (fileName) {\r\n      try {\r\n        await deleteUserProfilePicFromGCS(fileName);\r\n        console.log(`Profile picture ${fileName} deleted from GCS.`);\r\n      } catch (imgError) {\r\n        console.error(`Failed to delete profile picture ${fileName}:`, imgError);\r\n      }\r\n    }\r\n\r\n    console.log(`User with ID ${id} deleted successfully.`);\r\n\r\n    return {\r\n      success: true,\r\n      message: `User with ID ${id} deleted successfully.`,\r\n    };\r\n  } catch (error) {\r\n    console.error(`Error deleting user with ID ${id}:`, error);\r\n    return { success: false, errors: ['Internal server error occurred.'] };\r\n  }\r\n};\r\n"],"mappings":"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;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAAqD,OAAA,CAAAO,kBAAA,GAAAA,kBAAA;AAEO,MAAMG,yBAAyB,GAAG,MAAAA,CACvCzD,GAAQ,EACRqB,MAAc,EACdqC,WAA0B,KACvB;EACH,MAAM;IAAErD;EAAK,CAAC,GAAGL,GAAG;EACpB,IAAI;IACF;IACA,MAAM2D,gBAAgB,GAAG;MACvBnE,KAAK,EAAEoC,iBAAW,CAAC4B,WAAW;MAC9BvC,MAAM,EAAE;QAAEU,EAAE,EAAEN;MAAO;IACvB,CAAC;IAED,MAAM,CAACuC,YAAY,CAAC,GAAG,MAAMrE,kBAAQ,CAACC,KAAK,CAACmE,gBAAgB,CAAC;IAE7D,IAAIC,YAAY,CAACnE,MAAM,KAAK,CA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","ignoreList":[]}